---
# tasks file for ansible-role-sonarqube/

- name: "Create SonarQube system group"
  group:
    name: "{{ sonar_group }}"
    state: present

- name: "Create SonarQube system user"
  user:
    name: "{{ sonar_user }}"
    group: "{{ sonar_group }}"
    createhome: no
    shell: "/sbin/nologin"
    comment: "SonarQube System user"
    state: present

- name: "Create SonarQube directories"
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ sonar_user }}"
    group: "{{ sonar_group }}"
    mode: "u=rwx,g=rx,o="
  with_items:
    - "{{ sonar_install_directory }}"
    - "{{ sonar_logs_dir }}"
    - "{{ sonar_data_dir }}"
    - "{{ sonar_temp_dir }}"

- name: "Ensure JAVA is installed"
  command: "java -version"
  register: prereq_java
  changed_when: false

- name: "Fail if JAVA is not available"
  fail:
    msg: "JAVA is not installed or configured"
  when: not prereq_java.rc == 0

- name: "Execute Debian specific tasks"
  include_tasks: setup_debian.yml
  when: ansible_os_family == 'Debian'

- include_tasks: setup_prepare.yml

- include_tasks: setup_sonarqube.yml

- include_tasks: setup_plugin.yml
  with_items: "{{ sonar_plugins }}"
  loop_control:
    loop_var: "sonar_cplugin"

- meta: flush_handlers

- name: "Ensure web-interface is started"
  uri:
    url: "http://{{ sonar_web_host }}:{{ sonar_web_port }}/{{ sonar_web_context }}/"
    method: GET
  register: _sonar_page
  until: _sonar_page.status == 200
  retries: 60
  delay: 5
  check_mode: no # because this module does not support check mode
  ignore_errors: "{{ ansible_check_mode }}"

- name: "Verify the Sonar version"
  command: "grep 'SonarQube Server / {{ sonar_version }}' {{ sonar_logs_dir }}/web.log"
  register: grep_version
  check_mode: no
  failed_when: grep_version.rc >= 2 # for example, if log not found
  changed_when: grep_version.rc == 1 # if log found, but string not exist
  notify: fail if expected sonar version not found in log # triggered on change
  ignore_errors: "{{ ansible_check_mode }}"
